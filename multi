print("[Trade Fisch Helper] Loaded ✅")

--=== СЕРВИСЫ ===--
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

--=== ОСНОВНЫЕ ===--
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local hud = PlayerGui:WaitForChild("hud")
local trade = hud.safezone:WaitForChild("Trade")
local tradeHeader = trade:WaitForChild("Header")
local tradeList = trade.PlayerOffer.List.ScrollingFrame
local tradeFrame = tradeList.Parent.Parent
local Backpack = LocalPlayer:WaitForChild("Backpack")
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local RETradeAddItem = ReplicatedStorage:WaitForChild("packages").Net["RE/Trade/AddItem"]

--=== КОНФИГ ===--
local FISH_TO_TRADE = { "Typhoon Tailfin", "Twilight Tentaclefish" }

--=== СОСТОЯНИЕ ===--
local isTrading = false
local tradedFish = {}
local toggleButton
local debounce = false
local totalCache = 0

--=== JSON ===--
local function safeJson(url)
    local ok, res = pcall(function() return game:HttpGet(url, true) end)
    if not ok or not res or res == "" then return {} end
    local ok2, data = pcall(function() return HttpService:JSONDecode(res) end)
    return ok2 and data or {}
end

local fishData = safeJson("https://raw.githubusercontent.com/blankwhy1/lua/main/fischdata.json")
local mutationData = safeJson("https://raw.githubusercontent.com/blankwhy1/lua/main/mutationsdata.json")

--=== УТИЛИТЫ ===--
local function formatNumber(num)
    num = math.floor(num + 0.5)
    local s = tostring(num)
    while true do
        s, c = s:gsub("^(-?%d+)(%d%d%d)", "%1,%2")
        if c == 0 then break end
    end
    return s
end

local function parseName(txt)
    local mutation = txt:match("<font[^>]*>(.-)</font>")
    local name = txt:gsub("<font[^>]*>.-</font>", ""):match("^%s*(.-)%s*$")
    return mutation, name
end

local function parseWeight(txt)
    local n = tonumber(txt:match("[%d%.]+")) or 0
    return txt:find("T") and n * 1000 or n
end

local function parseStack(txt)
    return tonumber(txt:match("x(%d+)")) or 1
end

local function price(weight, base, mutation, stack)
    if not base then return 0 end
    local total = base * parseWeight(weight)
    if mutation and mutationData[mutation] and mutationData[mutation].Multiplier then
        total *= mutationData[mutation].Multiplier
    end
    return total * (stack > 1 and stack or 1)
end

--=== TOTAL LABEL ===--
local totalLabel = Instance.new("TextLabel")
totalLabel.Name = "TotalLabel"
totalLabel.Size = UDim2.new(1, 0, 0, 40)
totalLabel.Position = UDim2.new(0, 0, 1, -40)
totalLabel.BackgroundTransparency = 0.5
totalLabel.BackgroundColor3 = Color3.new(0, 0, 0)
totalLabel.TextColor3 = Color3.new(0, 1, 0)
totalLabel.TextScaled = true
totalLabel.Font = Enum.Font.SourceSansBold
totalLabel.ZIndex = 10
totalLabel.Parent = tradeFrame
totalLabel.Visible = true

--=== ПОДСЧЁТ TOTAL ===--
local function updateTotal()
    if debounce then return end
    debounce = true
    task.delay(0.2, function() debounce = false end)

    local total = 0
    for _, item in ipairs(tradeList:GetChildren()) do
        if item.Name == "ItemTemplate" then
            local name, weight, stack = item:FindFirstChild("ItemName"), item:FindFirstChild("Weight"), item:FindFirstChild("Stack")
            if name and weight then
                local mutation, fishName = parseName(name.Text)
                local fishInfo = fishData[fishName]
                if fishInfo then
                    total += price(weight.Text, fishInfo.Price, mutation, stack and parseStack(stack.Text) or 1)
                end
            end
        end
    end
    if total ~= totalCache then
        totalCache = total
        totalLabel.Text = "Total: " .. formatNumber(total)
    end
end

tradeList.ChildAdded:Connect(updateTotal)
tradeList.ChildRemoved:Connect(updateTotal)

--=== АВТО ТРЕЙД ===--
local function isTradeOpen()
    return trade.Visible
end

local function getFish()
    local fishes = {}
    for _, container in {Backpack, Character} do
        for _, item in ipairs(container:GetChildren()) do
            if item:FindFirstChild("link") and table.find(FISH_TO_TRADE, item.Name) then
                local id = item.link.Value
                if id and not tradedFish[id] then
                    table.insert(fishes, item)
                end
            end
        end
    end
    return fishes
end

local function tradeFish()
    for _, item in ipairs(getFish()) do
        if not isTrading then break end
        local id = item.link.Value
        tradedFish[id] = true
        pcall(function() RETradeAddItem:FireServer("Item", id, 1) end)
        task.wait(0.03)
    end
end

--=== КНОПКА ===--
local function toggleTrade()
    isTrading = not isTrading
    if not isTradeOpen() then isTrading = false end
    tradedFish = {}

    if isTrading then
        toggleButton.Text = "STOP"
        toggleButton.BackgroundColor3 = Color3.fromRGB(180, 0, 0)
        task.spawn(function()
            while isTrading and isTradeOpen() do
                tradeFish()
                RunService.Heartbeat:Wait()
            end
        end)
    else
        toggleButton.Text = "START"
        toggleButton.BackgroundColor3 = Color3.fromRGB(0, 140, 0)
    end
end

local function createButton()
    toggleButton = Instance.new("TextButton")
    toggleButton.Size = UDim2.new(0, 140, 0, 45)
    toggleButton.Position = UDim2.new(0.5, -70, 0, 8)
    toggleButton.AnchorPoint = Vector2.new(0.5, 0)
    toggleButton.BackgroundColor3 = Color3.fromRGB(0, 140, 0)
    toggleButton.TextColor3 = Color3.new(1, 1, 1)
    toggleButton.Font = Enum.Font.GothamBold
    toggleButton.TextScaled = true
    toggleButton.Text = "START"
    toggleButton.Parent = tradeHeader

    Instance.new("UICorner", toggleButton).CornerRadius = UDim.new(0, 12)
    local stroke = Instance.new("UIStroke")
    stroke.Thickness = 2
    stroke.Transparency = 0.6
    stroke.Color = Color3.fromRGB(255, 255, 255)
    stroke.Parent = toggleButton

    toggleButton.MouseButton1Click:Connect(toggleTrade)
end

--=== ХУКИ ===--
trade:GetPropertyChangedSignal("Visible"):Connect(function()
    toggleButton.Visible = isTradeOpen()
    updateTotal()
end)

UserInputService.InputBegan:Connect(function(input, gp)
    if not gp and input.KeyCode == Enum.KeyCode.T and isTradeOpen() then
        toggleTrade()
    end
end)

--=== ИНИЦИАЛИЗАЦИЯ ===--
createButton()
updateTotal()
