print("[Trade Fisch Helper] DEBUG + AUTO-FIND v4.0")

--=== –°–ï–†–í–ò–°–´ ===--
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

--=== –û–°–ù–û–í–ù–´–ï (–ê–í–¢–û-–ü–û–ò–°–ö) ===--
local LP = Players.LocalPlayer
local PG = LP:WaitForChild("PlayerGui", 10)

-- üîç –ê–í–¢–û-–ü–û–ò–°–ö TRADE UI
local function findTrade()
    for _, gui in pairs(PG:GetDescendants()) do
        if gui.Name == "Trade" and gui:IsA("Frame") then
            local header = gui:FindFirstChild("Header")
            local playerOffer = gui:FindFirstChild("PlayerOffer")
            if header and playerOffer then
                local list = playerOffer:FindFirstChild("List")
                if list then
                    local scrollingFrame = list:FindFirstChild("ScrollingFrame")
                    if scrollingFrame then
                        return gui, header, scrollingFrame, scrollingFrame.Parent.Parent
                    end
                end
            end
        end
    end
    return nil, nil, nil, nil
end

local trade, header, list, frame = findTrade()
if not trade then
    print("‚ùå TRADE UI –ù–ï –ù–ê–ô–î–ï–ù! –ñ–¥—ë–º...")
    PG.DescendantAdded:Connect(function(child)
        if child.Name == "Trade" and child:IsA("Frame") then
            task.wait(1)
            trade, header, list, frame = findTrade()
            if trade then
                print("‚úÖ TRADE –ù–ê–ô–î–ï–ù!")
            end
        end
    end)
end

-- üîç –ê–í–¢–û-–ü–û–ò–°–ö RETradeAddItem
local addItem
local function findRE()
    local packages = ReplicatedStorage:FindFirstChild("packages")
    if packages then
        local net = packages:FindFirstChild("Net")
        if net then
            local re = net:FindFirstChild("RE")
            if re then
                addItem = re:FindFirstChild("Trade")
                if addItem and addItem:FindFirstChild("AddItem") then
                    return addItem.AddItem
                end
            end
        end
    end
    return nil
end

addItem = findRE()
if not addItem then
    print("üîç –ò—â–µ–º RETradeAddItem...")
    ReplicatedStorage.DescendantAdded:Connect(function(child)
        if child.Name == "AddItem" and child.Parent.Name == "Trade" and child.Parent.Parent.Name == "RE" then
            addItem = child
            print("‚úÖ RETradeAddItem –ù–ê–ô–î–ï–ù!")
        end
    end)
end

--=== –ñ–î–Å–ú –û–°–ù–û–í–ù–´–ï –û–ë–™–ï–ö–¢–´ ===--
task.wait(2)
if not trade or not header or not list or not frame or not addItem then
    print("‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –Ω–∞–π–¥–µ–Ω—ã!")
    print("Trade:", trade and "OK" or "MISSING")
    print("Header:", header and "OK" or "MISSING")
    print("List:", list and "OK" or "MISSING")
    print("Frame:", frame and "OK" or "MISSING")
    print("AddItem:", addItem and "OK" or "MISSING")
    return
end

print("‚úÖ –í–°–ï –û–ë–™–ï–ö–¢–´ –ù–ê–ô–î–ï–ù–´!")

--=== –ö–û–ù–§–ò–ì ===--
local FISH = { "Typhoon Tailfin", "Twilight Tentaclefish" }
local DELAY = 0.005
local SCAN_INTERVAL = 0.1
local TOTAL_DEBOUNCE = 0.25

--=== Backpack/Character ===--
local bp = LP:WaitForChild("Backpack")
local function getChar()
    return LP.Character or LP.CharacterAdded:Wait()
end
local char = getChar()

--=== –î–ê–ù–ù–´–ï ===--
local success, fishData = pcall(function()
    return HttpService:JSONDecode(game:HttpGet("https://raw.githubusercontent.com/blankwhy1/lua/main/fischdata.json", true))
end)
local success2, mutData = pcall(function()
    return HttpService:JSONDecode(game:HttpGet("https://raw.githubusercontent.com/blankwhy1/lua/main/mutationsdata.json", true))
end)

if not success or not success2 then
    print("‚ùå –û–®–ò–ë–ö–ê JSON ‚Äî TOTAL –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å")
end

--=== –£–¢–ò–õ–ò–¢–´ ===--
local function fmt(n)
    n = math.floor(n + .5)
    local s = tostring(n):reverse()
    s = s:gsub("(%d%d%d)", "%1,")
    return s:reverse():gsub("^,", "")
end

local function getName(txt)
    local m = txt:match("<font[^>]*>(.-)</font>")
    local n = txt:gsub("<font[^>]*>.-</font>", ""):match("^%s*(.-)%s*$")
    return m or "", n or ""
end

local function getWeight(txt)
    local num = tonumber(txt:match("([%d%.]+)")) or 0
    return txt:find("T") and num * 1000 or num
end

local function getStack(txt)
    return txt and tonumber(txt:match("x(%d+)")) or 1
end

local function calcPrice(w, base, mut, stack)
    if not base or base <= 0 then return 0 end
    local p = base * getWeight(w)
    if mut ~= "" and mutData and mutData[mut] then
        p = p * (mutData[mut].Multiplier or 1)
    end
    return p * (stack > 1 and stack or 1)
end

--=== TOTAL GUI ===--
local totalLabel = Instance.new("TextLabel")
totalLabel.Name = "FischTotal"
totalLabel.Size = UDim2.new(1, 0, 0, 34)
totalLabel.Position = UDim2.new(0, 0, 1, -34)
totalLabel.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
totalLabel.BackgroundTransparency = 0.3
totalLabel.TextColor3 = Color3.fromRGB(0, 255, 100)
totalLabel.Font = Enum.Font.GothamBold
totalLabel.TextScaled = true
totalLabel.TextXAlignment = Enum.TextXAlignment.Left
totalLabel.Text = "Total: 0"
totalLabel.ZIndex = 15
totalLabel.Parent = frame
totalLabel.Visible = false

--=== TOTAL –õ–û–ì–ò–ö–ê ===--
local currentTotal = 0
local lastUpdate = 0

local function updateTotal()
    local now = tick()
    if now - lastUpdate < TOTAL_DEBOUNCE then return end
    lastUpdate = now

    if not fishData then return end

    local sum = 0
    for _, item in ipairs(list:GetChildren()) do
        if item.Name == "ItemTemplate" and item:FindFirstChild("ItemName") and item:FindFirstChild("Weight") then
            local mutation, fishName = getName(item.ItemName.Text)
            local data = fishData[fishName]
            if data and data.Price then
                sum = sum + calcPrice(item.Weight.Text, data.Price, mutation, getStack(item:FindFirstChild("Stack") and item.Stack.Text))
            end
        end
    end

    sum = math.floor(sum + 0.5)
    if math.abs(sum - currentTotal) >= 1 then
        currentTotal = sum
        totalLabel.Text = "Total: " .. fmt(sum)
    end
end

list.ChildAdded:Connect(function() task.delay(0.05, updateTotal) end)
list.ChildRemoved:Connect(updateTotal)

--=== SMART CACHE ===--
local fishCache = {}
local lastScan = 0
local cacheVersion = 0
local sent = {}

local function scanFishOnce()
    local now = tick()
    if now - lastScan < SCAN_INTERVAL then return end
    lastScan = now
    cacheVersion = cacheVersion + 1
    fishCache = {}

    local containers = {bp, getChar()}
    for _, container in pairs(containers) do
        if container then
            for _, item in pairs(container:GetChildren()) do
                if table.find(FISH, item.Name) and item:FindFirstChild("link") then
                    local id = item.link.Value
                    if id and not sent[id] then
                        fishCache[#fishCache + 1] = {id = id, version = cacheVersion}
                        print("üêü –ù–∞–π–¥–µ–Ω–∞ —Ä—ã–±–∞:", item.Name, id)  -- –î–ï–ë–ê–ì
                    end
                end
            end
        end
    end
    print("üì¶ –ö–≠–®:", #fishCache, "—Ä—ã–±")  -- –î–ï–ë–ê–ì
end

local function sendFromCache()
    for i = #fishCache, 1, -1 do
        local fish = fishCache[i]
        if fish.version ~= cacheVersion then
            table.remove(fishCache, i)
        elseif trading and trade.Visible then
            print("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ID:", fish.id)  -- –î–ï–ë–ê–ì
            sent[fish.id] = true
            addItem:FireServer("Item", fish.id, 1)
            table.remove(fishCache, i)
            task.wait(DELAY)
        else
            break
        end
    end
end

--=== –¢–û–†–ì–û–í–´–ô –¶–ò–ö–õ ===--
local trading = false

local function startTrading()
    task.spawn(function()
        while trading and trade.Visible do
            scanFishOnce()
            sendFromCache()
            RunService.Heartbeat:Wait()
        end
        trading = false
    end)
end

--=== START/STOP –ö–ù–û–ü–ö–ê ===--
local btn = Instance.new("TextButton")
btn.Name = "FischStartBtn"
btn.Size = UDim2.new(0, 120, 0, 38)
btn.Position = UDim2.new(0.5, -60, 0, 8)
btn.AnchorPoint = Vector2.new(0.5, 0)
btn.BackgroundColor3 = Color3.fromRGB(0, 140, 0)
btn.TextColor3 = Color3.new(1, 1, 1)
btn.Font = Enum.Font.GothamBold
btn.TextScaled = true
btn.Text = "START"
btn.ZIndex = 20
btn.Parent = header

local corner = Instance.new("UICorner", btn)
corner.CornerRadius = UDim.new(0, 10)

local stroke = Instance.new("UIStroke", btn)
stroke.Color = Color3.new(1,1,1)
stroke.Thickness = 2

btn.MouseButton1Click:Connect(function()
    if not trade.Visible then 
        print("‚ùå –¢–æ—Ä–≥–æ–≤–ª—è –∑–∞–∫—Ä—ã—Ç–∞!")
        return 
    end
    trading = not trading
    sent = {}
    fishCache = {}
    btn.Text = trading and "STOP" or "START"
    btn.BackgroundColor3 = trading and Color3.fromRGB(180, 0, 0) or Color3.fromRGB(0, 140, 0)
    
    if trading then
        print("üöÄ –ù–ê–ß–ò–ù–ê–ï–ú –¢–û–†–ì–û–í–õ–Æ!")
        startTrading()
    else
        print("‚èπÔ∏è –¢–û–†–ì–û–í–õ–Ø –û–°–¢–ê–ù–û–í–õ–ï–ù–ê")
    end
end)

--=== T –ö–õ–ê–í–ò–®–ê ===--
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.T and trade and trade.Visible then
        btn.MouseButton1Click:Fire()
    end
end)

--=== –í–ò–î–ò–ú–û–°–¢–¨ ===--
if trade then
    trade:GetPropertyChangedSignal("Visible"):Connect(function()
        local visible = trade.Visible
        btn.Visible = visible
        totalLabel.Visible = visible
        if visible then
            print("‚úÖ –¢–û–†–ì–û–í–õ–Ø –û–¢–ö–†–´–¢–ê")
            task.delay(0.5, function()
                updateTotal()
                scanFishOnce()
            end)
        else
            trading = false
            currentTotal = 0
            totalLabel.Text = "Total: 0"
            btn.Text = "START"
            btn.BackgroundColor3 = Color3.fromRGB(0, 140, 0)
            print("‚ùå –¢–û–†–ì–û–í–õ–Ø –ó–ê–ö–†–´–¢–ê")
        end
    end)
end

print("üéâ [Fisch Helper] –ó–ê–ì–†–£–ñ–ï–ù! –ñ–¥—ë–º –æ—Ç–∫—Ä—ã—Ç–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏...")
print("üîë T - —Å—Ç–∞—Ä—Ç/—Å—Ç–æ–ø | –ö–ù–û–ü–ö–ê START –≤ —Ö–µ–¥–µ—Ä–µ —Ç–æ—Ä–≥–æ–≤–ª–∏")
